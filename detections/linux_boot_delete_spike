N40_01_linux_boot_delete_spike
{
    meta:
        author = "Auto"
        short_description = "Detects high-frequency file deletion in /boot with process correlation and tuned exclusions"
        tactic = "{'TA0040': 'Impact'}"
        technique = "{'T1561.001': 'Disk Wipe: Disk Structure Wipe'}"
        reference = "https://attack.mitre.org/techniques/T1561/001/"
        severity = "High"
        event_type = "FILE_EVENT"

    events:
        // File deletion events in /boot
        $f.metadata.log_type = "LINUX_AUDITD"
        and $f.event.action = "FILE_DELETE"
        and re.regex($f.file.path, "(?i)^/boot/.*")

        // Associated process information
        $p.metadata.log_type = "LINUX_PROCESS"
        and $p.metadata.event_type = "PROCESS_LAUNCH"
        and $p.principal.asset.id == $f.principal.asset.id
        and $p.event.process.pid == $f.event.process.pid

    condition:
        // High frequency detections
        count($f) >= 5 within 1m

        // Exclusions: legitimate package managers (kernel updates, patching, system maintenance)
        and not re.regex($p.event.process.command_line,
            "(?i)(apt|apt-get|yum|dnf|rpm|zypper|pacman|update-grub|grub2-mkconfig|kernel|update)"
        )

        // Exclude known good system maintenance users
        and not $f.principal.user in [
            "root",
            "systemd",
            "package",
            "rpm",
            "apt"
        ]
}
