let lookback = 7d;
let suspiciousTlds = dynamic([".icu",".shop",".live"]);
let pasteDomains = dynamic([
  "pastebin.com","paste.ee","pastecode.io","ghostbin.com","hastebin.com",
  "dpaste.com","rentry.co","gist.github.com","raw.githubusercontent.com","paste.rs"
]);
DeviceNetworkEvents
| where TimeGenerated >= ago(lookback)
| extend RemoteUrl = tostring(RemoteUrl)
| extend RemoteIP = tostring(RemoteIP)
| extend InitiatingProcess = tostring(InitiatingProcessFileName)
| extend UrlLower = tolower(RemoteUrl)
| where isnotempty(RemoteUrl) or isnotempty(RemoteIP)
| extend IsDirectIP = iff(UrlLower matches regex @"^https?://(\d{1,3}\.){3}\d{1,3}(:\d+)?(/|$)", 1, 0)
| extend HasSuspiciousTld = iff(UrlLower has_any (suspiciousTlds), 1, 0)
| extend IsPasteSite = iff(UrlLower has_any (pasteDomains), 1, 0)
| where IsDirectIP == 1 or HasSuspiciousTld == 1 or IsPasteSite == 1
| summarize events=count(),
          first_time=min(TimeGenerated),
          last_time=max(TimeGenerated),
          sample_url=any(RemoteUrl),
          sample_ip=any(RemoteIP)
  by DeviceName, AccountName, InitiatingProcess
| order by events desc, last_time desc
