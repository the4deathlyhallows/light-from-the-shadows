rule 
{
    meta:
        author = "Auto"
        short_description = "Detects pkexec executions in auditd logs suggesting possible privilege escalation (CVE-2021-4034)"
        tactic = "Privilege Escalation"
        technique = "T1548.003"  // Abuse Elevation Control Mechanism: Sudo and Sudo Caching
        reference = "https://attack.mitre.org/techniques/T1548/003/"
        severity = "High"
        event_type = "AUDITD_EXECVE"

    condition:
        metadata.log_type == "AUDITD_EXECVE" and
        (
            re.regex(event.process.command_line, "(?i)\\bpkexec\\b") or
            re.regex(event.process.file.path, "(?i)/usr/bin/pkexec") or
            re.regex(event.process.file.name, "(?i)^pkexec$")
        )
        // Optional filtering: ignore legitimate system use
        and not re.regex(event.process.parent.command_line, "(?i)(gnome-shell|dbus-daemon)")
}
